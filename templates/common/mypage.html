{% extends 'base.html' %}
{% load static %}

{% block content %}
<!doctype html>
<html lang="en">
  <body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      {% include 'navbar.html'%} 
      <div class="android-content mdl-layout__content">
        <a name="top"></a>
        </br>
        </br>
        <div class="android-be-customized-section mdl-typography--text-center" style="display:flex;justify-content:center;align-items:center;top:30%;">
          <div class="demo-card-wide mdl-card mdl-shadow--2dp" style="align-items:center; width:40%">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">{{user.phone_number}}의 마이페이지</h2></br>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp">
                  <tbody>
                    <tr>
                      <td>이메일</td>
                      <td>{{user.email}}</td>
                    </tr>
                    <tr>
                      <td style="text-align:center">차량번호</td>
                      <td style="text-align:center">{{user.car_number}}</td>
                    </tr>
                    <tr style="text-align:center">
                      <td style="text-align:center">소유주차공간</td>
                      <td style="text-align:center">
                        {% if user.parking_set.all%}
                          있음
                        {% else %}
                          없음
                        {% endif %}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              </br>
              <button onclick="location.href='{% url 'common:add' %}'" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                주차공간 등록하기
              </button>
            </div>
          </div>
        </div></br></br>
        {% if user.parking_set.all%}
        <div class="android-be-customized-section mdl-typography--text-center" style="display:flex;justify-content:center;align-items:center;top:30%;">
          <div class="demo-card-wide mdl-card mdl-shadow--2dp" style="align-items:center; width:40%">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">주차공간 관리</h2></br>
            </div>
            <div class="mdl-card__supporting-text">
              <select name="select_box" id="select_box" onchange="select()">
                <!-- 유저가 소유하고 있는 주차공간 for문으로 하나씩 출력 -->
                {% for i in user.parking_set.all %}
                  <!-- 옵션에 주차공간 추가-->
                  <option value="{{ i.parking_name }}">{{ i.parking_name }}</option>
                {% endfor %}
              </select>
              </br></br>
              <div id="map" style="width:100%;height:350px;"></div>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <table>
                  <tbody>
                    <tr>
                      <td>예약상태</td>
                      <td>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-1">
                          <input type="checkbox" id="switch-1" class="mdl-switch__input" checked>
                          <span class="mdl-switch__label"></span>
                        </label>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        {% include 'footer.html'%} 
      </div>
    </div>
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  </body>
</html>

{% endblock %}

{% block script%}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ce903cdfbeb38247132d86bac3923a8b"></script>
<script>
  // 1. 최초 지도 생성(소유자가 가지고 있는 주차공간 중 가장 첫번째로 등록한 주차공간 출력)
  var first_lat = '{{user.parking_set.first.lat}}';
  var first_lon = '{{user.parking_set.first.lon}}';

  var mapContainer = document.getElementById('map'), // 지도를 표시할 div
  mapOption = {
      center: new daum.maps.LatLng(first_lat, first_lon), // 지도의 중심좌표
      level: 5 // 지도의 확대 레벨
  };

  //지도를 미리 생성
  var map = new daum.maps.Map(mapContainer, mapOption);
  //마커를 미리 생성
  var marker = new daum.maps.Marker({
    position: new daum.maps.LatLng(first_lat, first_lon),
    map: map
  });
  //1. 종료

  var check_select_value = "";
  // 2. select option 선택 시 동작되는 함수, 선택 값에 따라 지도의 위치를 변경시킴
  function select(){
    //select 된 값을 가져와서 select_value에 저장
    var value_str = document.getElementById('select_box')
    var select_value = value_str.options[value_str.selectedIndex].value;
    check_select_value = select_value;

    if(select_value=="none"){
      var map_box = document.getElementById('map');
      map_box.type = "hidden";

    }
  
    // 위도, 경도 저장할 변수 생성
    var lat = "";
    var lon = ""; 

    //현재 유저가 가지고 있는 주차공간중에
    //select_value와 DB 내의 parking_name이 일치하는 장소의 위도, 경도 값 저장
    {% for i in user.parking_set.all %}
      if( '{{i.parking_name}}'== select_value ){
        lat = '{{ i.lat }}';
        lon = '{{ i.lon }}';
      }
    {% endfor %}

    // 해당 주소에 대한 좌표를 받아서
    var coords = new daum.maps.LatLng(lat, lon);
    // 지도를 보여준다.
    mapContainer.style.display = "block";
    map.relayout();
    // 지도 중심을 변경한다.
    map.setCenter(coords);
    // 마커를 결과값으로 받은 위치로 옮긴다.
    marker.setPosition(coords);
  }
  // 2. 종료

  // 3. 예약상태를 관리하기 위한 토글 버튼 관련 jquery
  //if(check_select_value=='{{ user.parking_set.get(res_state="ON").parking_name }}'){
  //  $('switch-1').prop('checked', true);
  //}
  
  
  </script>
{% endblock %}